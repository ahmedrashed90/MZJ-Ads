
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>MZJ Ads â€” Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª v3 (Auto Detect)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tajawal Font -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- XLSX & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#fef3c7,#f5ebe2 40%,#ffffff 80%);
      color:var(--text);
    }

    /* Top unified bar */
    .mzj-topbar{
      position:sticky;
      top:0;
      z-index:999;
      background:#3e2420;
      color:#f9fafb;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
    }
    .mzj-topbar-inner{
      max-width:1350px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .mzj-topbar-title{font-size:16px;font-weight:800;}
    .mzj-topbar-sub{font-size:12px;opacity:.8;}
    .mzj-topbar-nav{display:flex;gap:10px;flex-wrap:wrap;}
    .mzj-topbar-link{
      padding:5px 14px;
      font-size:12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.5);
      color:#fff;
      text-decoration:none;
      transition:.2s;
    }
    .mzj-topbar-link:hover{
      background:#facc15;
      color:#1f2937;
      border-color:#facc15;
    }

    .app{
      max-width:1150px;
      margin:18px auto 24px;
      padding:0 16px 24px;
    }

    .card{
      background:#fff8ef;
      border-radius:var(--radius);
      border:1px solid rgba(226,232,240,0.9);
      box-shadow:0 14px 32px rgba(15,23,42,0.12);
      padding:14px 16px 16px;
      margin-bottom:14px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title{
      font-size:15px;
      font-weight:800;
      color:var(--brown);
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      gap:12px;
    }
    @media (min-width: 880px){
      .grid-2{
        grid-template-columns:2.1fr 1.3fr;
      }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }
    .field label{
      font-weight:600;
      color:var(--brown);
    }
    .field small{
      font-size:11px;
      color:var(--muted);
    }
    .field input[type="month"],
    .field input[type="file"]{
      padding:7px 11px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-family:inherit;
      font-size:13px;
      outline:none;
      transition:.12s ease border-color,.12s ease box-shadow,.12s ease background;
    }
    .field input[type="file"]{
      padding:6px 11px;
    }
    .field input[type="month"]:focus,
    .field input[type="file"]:focus{
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,0.5);
      background:#ffffff;
    }

    .btn{
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.12s ease all;
    }
    .btn-primary{
      background:var(--brown);
      color:#ffffff;
      box-shadow:0 10px 24px rgba(62,36,32,0.55);
    }
    .btn-primary:not(:disabled):hover{
      background:#2e1714;
      transform:translateY(-1px);
      box-shadow:0 16px 32px rgba(15,23,42,0.6);
    }
    .btn-primary:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .btn-ghost{
      background:transparent;
      color:var(--brown);
      border:1px dashed rgba(148,163,184,0.9);
    }
    .btn-ghost:hover{
      border-style:solid;
      background:#f9fafb;
    }

    .status-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.8);
    }
    .pill-ok{
      background:#ecfdf3;
      border-color:#bbf7d0;
      color:#166534;
    }
    .pill-bad{
      background:#fef2f2;
      border-color:#fecaca;
      color:#991b1b;
    }
    .pill-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:currentColor;
    }

    .log-area{
      max-height:260px;
      overflow:auto;
      padding:8px 10px;
      border-radius:12px;
      background:#f9fafb;
      border:1px dashed #e2e8f0;
      font-size:11px;
      line-height:1.7;
      direction:ltr;
      text-align:left;
    }
    .log-line-ok{color:#16a34a;}
    .log-line-warn{color:#ca8a04;}
    .log-line-err{color:#dc2626;}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#eff6ff;
      color:#1d4ed8;
      margin-inline-start:4px;
    }

    .fake-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:8px;
    }
    .fake-table th,
    .fake-table td{
      padding:4px 6px;
      border-bottom:1px solid #e2e8f0;
      white-space:nowrap;
      text-align:right;
    }
    .fake-table th{
      background:#f8fafc;
      font-weight:700;
      color:#475569;
    }

    .hint{
      font-size:11px;
      color:#94a3b8;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="mzj-topbar">
    <div class="mzj-topbar-inner">
      <div>
        <div class="mzj-topbar-title">MZJ Ads Workspace</div>
        <div class="mzj-topbar-sub">Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ§Øª (META / TikTok / Snap) â€” Auto Detect v3</div>
      </div>
      <nav class="mzj-topbar-nav">
        <a href="dashboard.html" class="mzj-topbar-link">Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
        <a href="platforms.html" class="mzj-topbar-link" style="background:#facc15;color:#1f2937;border-color:#facc15;">Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª</a>
        <a href="messages.html" class="mzj-topbar-link">Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a>
      </nav>
    </div>
  </div>

  <main class="app">
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Ø±ÙØ¹ ÙƒÙ„ Ø´ÙŠØªØ§Øª Ø§Ù„Ù…Ù†ØµØ§Øª Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©</div>
          <div class="card-sub">
            Ø§Ø®ØªØ§Ø± Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ø±ÙØ¹ ÙƒÙ„ Ø´ÙŠØªØ§Øª META / TikTok / Snap (ØªÙØ§Ø¹Ù„ØŒ Ù…Ø´Ø§Ù‡Ø¯Ø§ØªØŒ Ù„ÙŠØ¯Ø²ØŒ Ø±Ø³Ø§Ø¦Ù„ØŒ Ù…ÙƒØ§Ù„Ù…Ø§ØªØŒ Ø¯Ø§ÙŠØ±ÙƒØª) Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©.
            Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡ÙŠÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø§Ù„Ù…Ù†ØµØ© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª ÙˆÙŠØ®Ø²Ù†
            <span class="badge">raw + norm</span>
            ÙÙŠ Firestore.
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="grid" style="gap:10px;">
          <div class="field">
            <label for="monthInput">Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <input type="month" id="monthInput" />
            <small>ÙŠÙØ³ØªØ®Ø¯Ù… ÙÙŠ Ù…Ø³Ø§Ø± Firestore: analytics / YYYY-MM / ...</small>
          </div>

          <div class="field">
            <label for="fileInput">ÙƒÙ„ Ø´ÙŠØªØ§Øª Ø§Ù„Ù…Ù†ØµØ§Øª (CSV / Excel)</label>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" multiple />
            <small>Ù…Ù…ÙƒÙ† ØªØ®ØªØ§Ø± ÙƒÙ„ Ù…Ù„ÙØ§Øª META Ùˆ TikTok Ùˆ Snap Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ù„ÙŠØ¯Ø²ØŒ Ø±Ø³Ø§Ø¦Ù„ØŒ Ù…ÙƒØ§Ù„Ù…Ø§ØªØŒ Ù…Ø´Ø§Ù‡Ø¯Ø©â€¦ Ø¥Ù„Ø®).</small>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <button id="uploadBtn" class="btn btn-primary">
              Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ ÙÙŠ Firestore
            </button>
            <button id="testParseBtn" class="btn btn-ghost">
              ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ Ù…Ù„Ù ÙÙ‚Ø·
            </button>
          </div>

          <div class="hint">
            Ø§Ù„Ø³ÙŠØ³ØªÙ… Ø¨ÙŠØ­Ø§ÙˆÙ„ ÙŠÙƒØªØ´Ù Ø§Ù„Ù…Ù†ØµØ© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ù„Ù.
            Ù„Ùˆ Ù…Ù„Ù Ù…Ø´ Ù…ÙÙ‡ÙˆÙ…ØŒ Ù‡ØªØ¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© ÙˆÙŠÙØªØ®Ø·Ù‰ Ø§Ù„Ù…Ù„Ù.
          </div>
        </div>

        <div>
          <div class="field">
            <label>Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ©</label>
            <div id="statusPill" class="pill">
              <span class="pill-dot"></span>
              <span id="statusText">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø´Ù‡Ø± ÙˆÙ…Ù„ÙØ§Øª.</span>
            </div>
          </div>

          <div class="field" style="margin-top:8px;">
            <label>Preview Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ø£ÙˆÙ„ Ù…Ù„Ù</label>
            <table class="fake-table" id="headerPreview">
              <thead>
                <tr><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 1</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 2</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 3</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 4</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 5</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 6</th></tr>
              </thead>
              <tbody>
                <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ù…Ù„Ù Ù…Ø±ÙÙˆØ¹.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>Log / Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</label>
        <div id="logArea" class="log-area">
          <!-- log lines -->
        </div>
      </div>

      <div class="status-line">
        <div>ÙƒÙ„ ØµÙ Ø¨ÙŠØªØ®Ø²Ù† Ø¨Ø§Ù„Ù€ raw ÙƒØ§Ù…Ù„ + norm Ù…ÙˆØ­Ø¯ (Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯).</div>
        <div>Project: <code>mzj-ads / analytics</code></div>
      </div>
    </section>
  </main>

  <script>
    // ===== Firebase Init (compat) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDh7ofrYeZ_KWlk7NJmBuZw0NLm5xkNBks",
      authDomain: "mzj-ads.firebaseapp.com",
      projectId: "mzj-ads",
      storageBucket: "mzj-ads.firebasestorage.app",
      messagingSenderId: "830896442086",
      appId: "1:830896442086:web:f42e7329bd3a8400a90927"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== DOM refs =====
    const monthInput   = document.getElementById("monthInput");
    const fileInput    = document.getElementById("fileInput");
    const uploadBtn    = document.getElementById("uploadBtn");
    const testParseBtn = document.getElementById("testParseBtn");
    const statusPill   = document.getElementById("statusPill");
    const statusText   = document.getElementById("statusText");
    const logArea      = document.getElementById("logArea");
    const headerPreviewTbl = document.getElementById("headerPreview").querySelector("tbody");

    function log(message, type="ok"){
      const line = document.createElement("div");
      if(type === "ok")   line.className = "log-line-ok";
      if(type === "warn") line.className = "log-line-warn";
      if(type === "err")  line.className = "log-line-err";
      line.textContent = message;
      logArea.appendChild(line);
      logArea.scrollTop = logArea.scrollHeight;
    }

    function setStatus(text, type="ok"){
      statusText.textContent = text;
      statusPill.classList.remove("pill-ok","pill-bad");
      if(type === "ok"){
        statusPill.classList.add("pill-ok");
      }else if(type === "bad"){
        statusPill.classList.add("pill-bad");
      }
    }

    function toNumber(val){
      if(val === null || val === undefined) return 0;
      if(typeof val === "number") return val;
      const cleaned = String(val).replace(/,/g,"").trim();
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }

    function pickFirst(row, candidates){
      for(const key of candidates){
        if(key in row && row[key] !== "" && row[key] !== null && row[key] !== undefined){
          return row[key];
        }
      }
      return null;
    }

    function updateHeaderPreview(headers){
      headerPreviewTbl.innerHTML = "";
      if(!headers || !headers.length){
        headerPreviewTbl.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.</td></tr>';
        return;
      }
      const row = document.createElement("tr");
      for(let i=0;i<6;i++){
        const td = document.createElement("td");
        td.textContent = headers[i] || "-";
        row.appendChild(td);
      }
      headerPreviewTbl.appendChild(row);
    }

    function detectFileType(file){
      const name = file.name.toLowerCase();
      if(name.endsWith(".csv")) return "csv";
      if(name.endsWith(".xlsx") || name.endsWith(".xls")) return "excel";
      return "unknown";
    }

    function parseFile(file){
      return new Promise((resolve, reject)=>{
        const type = detectFileType(file);
        if(type === "csv"){
          Papa.parse(file,{
            header:true,
            skipEmptyLines:true,
            complete:(res)=>{
              resolve(res.data);
            },
            error:(err)=>reject(err)
          });
        }else if(type === "excel"){
          const reader = new FileReader();
          reader.onload = (e)=>{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:"array"});
            const sheetName = workbook.SheetNames[0];
            const ws = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws,{defval:""});
            resolve(json);
          };
          reader.onerror = (e)=>reject(e);
          reader.readAsArrayBuffer(file);
        }else{
          reject(new Error("Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ Excel."));
        }
      });
    }

    // ===== Column Maps (Ù†ÙØ³ Ø§Ù„Ù„ÙŠ Ø§ØªÙÙ‚Ù†Ø§ Ø¹Ù„ÙŠÙ‡) =====
    const META_COLUMN_MAP = {
      spend: [
        "Amount spent (SAR)",
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†ÙØ§Ù‚Ù‡ (SAR)",
        "Amount spent"
      ],
      impressions: [
        "Impressions",
        "Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±"
      ],
      reach: [
        "Reach",
        "Ø§Ù„ÙˆØµÙˆÙ„"
      ],
      results: [
        "Results",
        "Ø§Ù„Ù†ØªØ§Ø¦Ø¬"
      ],
      costPerResult: [
        "Cost per results",
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø©"
      ],
      adSetName: [
        "Ad set name",
        "Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"
      ],
      campaignName: [
        "Campaign name",
        "Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      adName: [
        "Ad name",
        "Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ]
    };

    const TIKTOK_COLUMN_MAP = {
      adGroupName: [
        "Ad group name"
      ],
      spend: [
        "Cost",
        "Total cost"
      ],
      impressions: [
        "Impressions"
      ],
      clicks: [
        "Clicks (destination)",
        "Clicks"
      ],
      ctr: [
        "CTR (destination)",
        "Click-through rate"
      ],
      results: [
        "Results"
      ],
      costPerResult: [
        "Cost per result"
      ],
      resultRate: [
        "Result rate"
      ],
      conversionsMmp: [
        "Conversions [MMP]"
      ],
      conversionsSan: [
        "Conversions [SAN]"
      ],
      costPerConversionMmp: [
        "Cost per conversion [MMP]"
      ],
      costPerConversionSan: [
        "Cost per conversion [SAN]"
      ],
      cvrMmp: [
        "Conversion rate (CVR) [MMP]"
      ],
      cvrSan: [
        "Conversion rate (CVR) [SAN]"
      ],
      deepFunnelResult: [
        "Deep funnel result"
      ],
      costPerDeepFunnelResult: [
        "Cost per deep funnel result"
      ],
      deepFunnelRate: [
        "Deep funnel result rate"
      ]
    };

    const SNAP_COLUMN_MAP = {
      campaignId: [
        "Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      campaignName: [
        "Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      adSetId: [
        "Ø±Ù…Ø² ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"
      ],
      adSetName: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ø§Ø³Ù…"
      ],
      adSetStatus: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©"
      ],
      dailyBudget: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©"
      ],
      lifetimeBudget: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø·ÙˆØ§Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      adSetGoal: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ù‡Ø¯Ù"
      ],
      bid: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±"
      ],
      spend: [
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†ÙØ§Ù‚Ù‡"
      ],
      results: [
        "Ø§Ù„Ù†ØªÙŠØ¬Ø©"
      ],
      resultType: [
        "Ù†ÙˆØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©"
      ],
      costPerResult: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø©"
      ],
      costPerResultType: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù†ØªÙŠØ¬Ø©"
      ],
      impressions: [
        "Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©"
      ],
      eCPM: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ù„ÙƒÙ„ Ø£Ù„Ù Ø¸Ù‡ÙˆØ± (eCPM)"
      ],
      clicks: [
        "Ø§Ù„Ù†Ù‚Ø±Ø§Øª"
      ],
      eCPC: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„ÙƒÙ„ Ù†Ù‚Ø±Ø© (eCPC)"
      ],
      installs: [
        "Ø¹Ù…Ù„ÙŠØ§Øª ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
      ],
      costPerInstall: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ«Ø¨ÙŠØª"
      ],
      installRate: [
        "Ù…Ø¹Ø¯Ù„ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
      ],
      adId: [
        "Ø±Ù…Ø² ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ],
      adName: [
        "Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ],
      adStatus: [
        "Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©"
      ],
      adType: [
        "Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ]
    };

    // ===== ÙƒØ´Ù Ø§Ù„Ù…Ù†ØµØ© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± =====
    function detectPlatform(headers, fileName){
      const lower = headers.map(h => String(h || "").toLowerCase());
      const name  = fileName.toLowerCase();

      // TikTok
      const isTikTok = lower.some(h => h.includes("ad group name") || h.includes("[mmp]") || h.includes("ctr (destination)"));
      if(isTikTok || name.includes("tiktok") || name.includes("ØªÙŠÙƒ ØªÙˆÙƒ")){
        return "tiktok";
      }

      // Snapchat
      const isSnap = lower.some(h => h.includes("Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ù…Ù„Ø©") || h.includes("Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©") || h.includes("Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©"));
      if(isSnap || name.includes("snap") || name.includes("Ø³Ù†Ø§Ø¨")){
        return "snap";
      }

      // META
      const isMeta = lower.some(h => h.includes("ad set name") || h.includes("amount spent") || h.includes("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†ÙØ§Ù‚Ù‡"));
      if(isMeta || name.includes("meta") || name.includes("ÙÙŠØ³") || name.includes("Ø§Ù†Ø³Øª")){
        return "meta";
      }

      return "unknown";
    }

    // ===== ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª (messages / leads / views / engagement / calls / direct) =====
    function detectSheetType(platform, headers, sampleRows, fileName){
      const name = fileName.toLowerCase();
      const lowerHeaders = headers.map(h => String(h || "").toLowerCase());
      const joinedHeaders = lowerHeaders.join(" | ");

      function containsAny(str, arr){
        const s = str.toLowerCase();
        return arr.some(k => s.includes(k.toLowerCase()));
      }

      // Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹
      if(containsAny(name, ["Ù„ÙŠØ¯Ø²","lead","leads"])) return "leads";
      if(containsAny(name, ["Ø±Ø³Ø§Ø¦Ù„","message","messages","Ù…Ø±Ø§Ø³Ù„Ø©","Ù…Ø­Ø§Ø¯Ø«"])) return "messages";
      if(containsAny(name, ["Ù…Ø´Ø§Ù‡Ø¯Ø§Øª","Ù…Ø´Ø§Ù‡Ø¯Ø©","view","views","reach"])) return "views";
      if(containsAny(name, ["ØªÙØ§Ø¹Ù„","engagement"])) return "engagement";
      if(containsAny(name, ["Ù…ÙƒØ§Ù„Ù…Ø§Øª","Ù…ÙƒØ§Ù„Ù…Ù‡","calls","call"])) return "calls";
      if(containsAny(name, ["Ø¯Ø§ÙŠØ±ÙƒØª","direct"])) return "direct";

      // Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ùˆ Ø§Ù„Ø§Ø³Ù… Ù…Ø´ ÙˆØ§Ø¶Ø­
      if(containsAny(joinedHeaders, ["message","messages","Ù…Ø­Ø§Ø¯Ø«","Ø±Ø³Ø§Ø¦Ù„"])) return "messages";
      if(containsAny(joinedHeaders, ["lead","leads","Ù†Ù…ÙˆØ°Ø¬","Ù†Ù…ÙˆØ°Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª","form"])) return "leads";
      if(containsAny(joinedHeaders, ["view","Ù…Ø´Ø§Ù‡Ø¯Ø§Øª","Ù…Ø´Ø§Ù‡Ø¯Ø©","thruplay","play"])) return "views";
      if(containsAny(joinedHeaders, ["engagement","ØªÙØ§Ø¹Ù„","clicks","ctr"])) return "engagement";
      if(containsAny(joinedHeaders, ["call","Ù…ÙƒØ§Ù„Ù…Ø§Øª","phone"])) return "calls";

      // fallback Ø­Ø³Ø¨ Ø§Ù„Ù…Ù†ØµØ©
      if(platform === "meta" || platform === "tiktok"){
        return "engagement";
      }
      if(platform === "snap"){
        return "views";
      }
      return "engagement";
    }

    function getCollectionName(platform){
      if(platform === "meta")   return "meta_raw";
      if(platform === "tiktok") return "tiktok_raw";
      if(platform === "snap")   return "snap_raw";
      return "other_raw";
    }

    // ===== norm builders =====
    function buildNormForMeta(row, sheetType, monthKey){
      const spend       = toNumber(pickFirst(row, META_COLUMN_MAP.spend));
      const impressions = toNumber(pickFirst(row, META_COLUMN_MAP.impressions));
      const reach       = toNumber(pickFirst(row, META_COLUMN_MAP.reach));
      const results     = toNumber(pickFirst(row, META_COLUMN_MAP.results));
      const costPerResult = toNumber(pickFirst(row, META_COLUMN_MAP.costPerResult));
      const adSetName   = pickFirst(row, META_COLUMN_MAP.adSetName);
      const campaignName= pickFirst(row, META_COLUMN_MAP.campaignName);
      const adName      = pickFirst(row, META_COLUMN_MAP.adName);

      const ctr         = impressions > 0 && results > 0 ? (results / impressions) * 100 : null;
      const cpr         = results > 0 ? spend / results : null;

      return {
        platform: "meta",
        sheetType,
        monthKey,
        campaignName: campaignName || null,
        adSetName: adSetName || null,
        adName: adName || null,
        spend,
        impressions,
        reach,
        results,
        costPerResult: costPerResult || cpr,
        ctr,
        cpc: null
      };
    }

    function buildNormForTikTok(row, sheetType, monthKey){
      const spend       = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.spend));
      const impressions = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.impressions));
      const clicks      = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.clicks));
      const ctrRaw      = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.ctr));
      const results     = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.results));
      const costPerRes  = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.costPerResult));
      const adGroupName = pickFirst(row, TIKTOK_COLUMN_MAP.adGroupName);

      const ctr = ctrRaw || (impressions > 0 && clicks > 0 ? (clicks / impressions) * 100 : null);
      const cpc = clicks > 0 ? spend / clicks : null;
      const cpr = results > 0 ? spend / results : null;

      const convMmp = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.conversionsMmp));
      const convSan = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.conversionsSan));
      const cvrMmp  = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.cvrMmp));
      const cvrSan  = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.cvrSan));

      return {
        platform: "tiktok",
        sheetType,
        monthKey,
        adGroupName: adGroupName || null,
        campaignName: null,
        adName: null,
        spend,
        impressions,
        clicks,
        ctr,
        results,
        costPerResult: costPerRes || cpr,
        cpc,
        conversionsMmp: convMmp || null,
        conversionsSan: convSan || null,
        cvrMmp: cvrMmp || null,
        cvrSan: cvrSan || null
      };
    }

    function buildNormForSnap(row, sheetType, monthKey){
      const spend       = toNumber(pickFirst(row, SNAP_COLUMN_MAP.spend));
      const impressions = toNumber(pickFirst(row, SNAP_COLUMN_MAP.impressions));
      const clicks      = toNumber(pickFirst(row, SNAP_COLUMN_MAP.clicks));
      const results     = toNumber(pickFirst(row, SNAP_COLUMN_MAP.results));
      const costPerRes  = toNumber(pickFirst(row, SNAP_COLUMN_MAP.costPerResult));
      const campaignId  = pickFirst(row, SNAP_COLUMN_MAP.campaignId);
      const campaignName= pickFirst(row, SNAP_COLUMN_MAP.campaignName);
      const adSetName   = pickFirst(row, SNAP_COLUMN_MAP.adSetName);
      const adName      = pickFirst(row, SNAP_COLUMN_MAP.adName);

      const ctr = impressions > 0 && clicks > 0 ? (clicks / impressions) * 100 : null;
      const cpc = clicks > 0 ? spend / clicks : null;
      const cpr = results > 0 ? spend / results : null;

      return {
        platform: "snap",
        sheetType,
        monthKey,
        campaignId: campaignId || null,
        campaignName: campaignName || null,
        adSetName: adSetName || null,
        adName: adName || null,
        spend,
        impressions,
        clicks,
        results,
        costPerResult: costPerRes || cpr,
        ctr,
        cpc
      };
    }

    function buildNormRow(row, platform, sheetType, monthKey){
      if(platform === "meta"){
        return buildNormForMeta(row, sheetType, monthKey);
      }
      if(platform === "tiktok"){
        return buildNormForTikTok(row, sheetType, monthKey);
      }
      if(platform === "snap"){
        return buildNormForSnap(row, sheetType, monthKey);
      }
      return { platform, sheetType, monthKey };
    }

    async function handleTestParse(){
      const files = fileInput.files;
      if(!files || !files.length){
        alert("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙŠØ§ Ø®Ø§Ù„.");
        return;
      }
      const file = files[0];
      logArea.innerHTML = "";
      setStatus("Ø¬Ø§Ø±ÙŠ ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ Ù…Ù„Ùâ€¦","ok");
      log("â³ Test Parse: Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ Ù…Ù„Ù ÙÙ‚Ø·â€¦","warn");

      try{
        const rows = await parseFile(file);
        if(!rows.length){
          setStatus("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙÙˆÙ.","bad");
          log("âš  Ø§Ù„Ù…Ù„Ù ÙØ§Ø¶ÙŠ Ø£Ùˆ Ù…ÙÙŠÙ‡ÙˆØ´ Ø¯Ø§ØªØ§.","warn");
          return;
        }
        const headers = Object.keys(rows[0]);
        updateHeaderPreview(headers);

        const platform = detectPlatform(headers, file.name);
        const sheetType = detectSheetType(platform, headers, rows.slice(0,5), file.name);

        log("ğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù: " + file.name,"ok");
        log("ğŸ” Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: " + rows.length,"ok");
        log("ğŸ§­ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: " + platform,"ok");
        log("ğŸ¯ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: " + sheetType,"ok");
        log("ğŸ‘€ Ø£ÙˆÙ„ 3 ØµÙÙˆÙ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:","ok");
        rows.slice(0,3).forEach((r,idx)=>{
          log("#" + (idx+1) + ": " + JSON.stringify(r), "ok");
        });

        setStatus("ØªÙ…Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­. Ù„Ùˆ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø¸Ø¨ÙˆØ·ØŒ Ø¯ÙˆØ³ Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª.","ok");
      }catch(err){
        console.error(err);
        log("âŒ Error Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: " + err.message,"err");
        setStatus("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù…Ø§Øª.","bad");
      }
    }

    async function handleUpload(){
      const files = fileInput.files;
      const monthVal = monthInput.value;

      if(!files || !files.length){
        alert("Ø§Ø®ØªØ§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ Ø®Ø§Ù„.");
        return;
      }
      if(!monthVal){
        alert("Ø§Ø®ØªØ§Ø± Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ§ Ø®Ø§Ù„.");
        return;
      }

      logArea.innerHTML = "";
      setStatus("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ±ÙØ¹Ù‡Ø§â€¦","ok");
      uploadBtn.disabled   = true;
      testParseBtn.disabled= true;

      const monthKey = monthVal;
      let globalSuccess = 0;
      let globalFail    = 0;

      try{
        for(const file of files){
          log("==========","warn");
          log("ğŸ“„ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: " + file.name,"warn");

          let rows;
          try{
            rows = await parseFile(file);
          }catch(errFile){
            log("âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + errFile.message,"err");
            globalFail++;
            continue;
          }

          if(!rows.length){
            log("âš  Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙÙˆÙ. ØªÙ… ØªØ®Ø·ÙŠÙ‡.","warn");
            continue;
          }

          const headers = Object.keys(rows[0]);
          const platform = detectPlatform(headers, file.name);
          const sheetType = detectSheetType(platform, headers, rows.slice(0,5), file.name);

          if(platform === "unknown"){
            log("âš  Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù. ØªÙ… ØªØ®Ø·ÙŠÙ‡.","warn");
            continue;
          }

          updateHeaderPreview(headers);
          log("ğŸ§­ Ø§Ù„Ù…Ù†ØµØ©: " + platform + " | ğŸ¯ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª: " + sheetType,"ok");
          const colName = getCollectionName(platform);

          let successCount = 0;
          let failCount    = 0;

          for(let i=0;i<rows.length;i++){
            const rawRow = rows[i];
            const values = Object.values(rawRow || {});
            const allEmpty = values.every(v => v === null || v === undefined || String(v).trim() === "");
            if(allEmpty) continue;

            const norm = buildNormRow(rawRow, platform, sheetType, monthKey);
            const docData = {
              raw: rawRow,
              norm,
              platform,
              sheetType,
              monthKey,
              sourceFile: file.name,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            try{
              await db.collection("analytics")
                .doc(monthKey)
                .collection(colName)
                .add(docData);
              successCount++;
            }catch(err){
              failCount++;
              if(failCount <= 3){
                log("âŒ Error Ø­ÙØ¸ Ø§Ù„ØµÙ " + (i+1) + ": " + err.message,"err");
              }
            }
          }

          log("ğŸ“¦ Ø§Ù„Ù…Ù„Ù " + file.name + " â€” ØªÙ… Ø±ÙØ¹ " + successCount + " ØµÙØŒ Ù…Ø¹ " + failCount + " Ø®Ø·Ø£.","ok");
          globalSuccess += successCount;
          globalFail    += failCount;
        }

        log("==========","warn");
        log("ğŸ¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙØ¹ â€” Ù†Ø§Ø¬Ø­ = " + globalSuccess + " | ÙØ§Ø´Ù„ = " + globalFail,"ok");
        if(globalSuccess > 0 && globalFail === 0){
          setStatus("ØªÙ… Ø±ÙØ¹ ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ analytics/" + monthKey + "/...","ok");
        }else if(globalSuccess > 0){
          setStatus("ØªÙ… Ø±ÙØ¹ " + globalSuccess + " ØµÙØŒ Ù…Ø¹ " + globalFail + " Ø®Ø·Ø£. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Log.","bad");
        }else{
          setStatus("Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ ØµÙ. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù€ Log.","bad");
        }

      }catch(err){
        console.error(err);
        log("âŒ Error Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª: " + err.message,"err");
        setStatus("ÙØ´Ù„ Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Log.","bad");
      }finally{
        uploadBtn.disabled   = false;
        testParseBtn.disabled= false;
      }
    }

    uploadBtn.addEventListener("click", handleUpload);
    testParseBtn.addEventListener("click", handleTestParse);

    (function presetMonth(){
      const now = new Date();
      const y   = now.getFullYear();
      const m   = String(now.getMonth()+1).padStart(2,"0");
      monthInput.value = y + "-" + m;
    })();
  </script>
</body>
</html>
