<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <style>
  /* Ø´ÙŠÙ„ Ø£ÙŠ Ù…Ø³Ø§Ø­Ø© ÙÙˆÙ‚ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± */
  body {
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Ø³Ø­Ø¨ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± Ù„Ø£Ø¹Ù„Ù‰ */
  .mzj-topbar {
    margin-top: 0 !important;
  }

  /* ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„ØªØµÙ…ÙŠÙ…Ø§Øª Ø¨ÙŠÙƒÙˆÙ† ÙÙŠ padding Ù„Ø¹Ù†ØµØ± HTML Ù†ÙØ³Ù‡ */
  html {
    padding: 0 !important;
    margin: 0 !important;
  }

  /* Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ margin Ù…Ù† Ø£ÙˆÙ„ Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± */
  .app-shell,
  .container,
  main {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
</style>

<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MZJ Ads â€” Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{font-family:Tajawal;background:#f5eee8;margin:0;padding:20px;}
    .card{background:#fff;border-radius:14px;padding:20px;max-width:750px;margin:auto;
          box-shadow:0 10px 25px rgba(0,0,0,.1);border:1px solid #e5e7eb;}
    h2{margin-top:0;color:#3e2420;}
    label{font-weight:600;margin-bottom:6px;display:block;color:#3e2420;font-size:14px;}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #ddd;
                 margin-bottom:15px;font-family:inherit;font-size:13px;background:#fafafa;}
    button{padding:10px 18px;border:none;border-radius:999px;background:#3e2420;
           color:#fff;font-weight:700;cursor:pointer;font-size:13px;
           box-shadow:0 8px 18px rgba(62,36,32,.35);}
    button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;}
    button:not(:disabled):hover{background:#2b1612;}
    small{display:block;font-size:11px;color:#6b7280;margin-top:-8px;margin-bottom:10px;}
    #log{background:#020617;color:#e5e7eb;padding:12px;border-radius:8px;
         font-size:12px;height:260px;overflow:auto;white-space:pre-wrap;
         font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .tag{display:inline-flex;gap:6px;align-items:center;font-size:11px;color:#4b5563;margin-bottom:10px;}
    .tag-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;}
  </style>

<style>

.mzj-topbar{
  position:sticky;
  top:0;
  z-index:50;
  background:#3e2420;
  color:#f9fafb;
  box-shadow:0 10px 30px rgba(15,23,42,0.5);
}
.mzj-topbar-inner{
  max-width:1320px;
  margin:0 auto;
  padding:10px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.mzj-topbar-left{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.mzj-topbar-title{
  font-weight:800;
  font-size:15px;
}
.mzj-topbar-sub{
  font-size:11px;
  opacity:.9;
}
.mzj-topbar-nav{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.mzj-topbar-link{
  font-size:12px;
  padding:5px 10px;
  border-radius:999px;
  border:1px solid rgba(248,250,252,0.45);
  color:#f9fafb;
  text-decoration:none;
  transition:.15s ease all;
}
.mzj-topbar-link:hover{
  background:#facc15;
  color:#1f2937;
  border-color:#facc15;
}
@media(max-width:640px){
  .mzj-topbar-inner{
    flex-direction:column;
    align-items:flex-start;
  }
  .mzj-topbar-nav{
    width:100%;
    justify-content:flex-start;
    flex-wrap:wrap;
  }
}

</style>
</head>
<body>

  <div class="mzj-topbar">
    <div class="mzj-topbar-inner">
      <div class="mzj-topbar-left">
        <span class="mzj-topbar-title">MZJ Ads Workspace</span>
        <span class="mzj-topbar-sub">Ù…Ù†ØµØ© ÙˆØ§Ø­Ø¯Ø© Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
      </div>
      <nav class="mzj-topbar-nav">
      <a href="dashboard.html" class="mzj-topbar-link">Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
      <a href="platforms.html" class="mzj-topbar-link">Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª</a>
      <a href="messages.html" class="mzj-topbar-link">Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a>
      </nav>
    </div>
  </div>


  <div class="card">
    <div class="tag"><span class="tag-dot"></span><span>MZJ Ads â€” Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ§Øª (Meta / TikTok / Snap)</span></div>
    <h2>Ø±ÙØ¹ Ø´ÙŠØª Ø§Ù„Ù…Ù†ØµØ§Øª (Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…)</h2>

    <label>Ø§Ù„Ø´Ù‡Ø±</label>
    <input type="month" id="month"/>
    <small>Ù‡ÙŠØªØ®Ø²Ù† ÙÙŠ: analytics / {"{Ø§Ù„Ø´Ù‡Ø±}"} / platforms_raw</small>

    <label>Ø§Ù„Ù…Ù†ØµØ©</label>
    <select id="platform">
      <option value="Meta">Meta (Facebook / Instagram)</option>
      <option value="TikTok">TikTok</option>
      <option value="Snapchat">Snapchat</option>
      <option value="Other">Ù…Ù†ØµØ© Ø£Ø®Ø±Ù‰</option>
    </select>

    <label>Ù…Ù„Ù Ø§Ù„Ù…Ù†ØµØ§Øª (CSV Ø£Ùˆ Excel)</label>
    <input type="file" id="file" accept=".csv,.xlsx,.xls"/>
    <small>Ø´ÙŠØª ÙÙŠÙ‡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚ ÙˆØ§Ù„Ø¸Ù‡ÙˆØ± ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø£ÙŠ ÙÙˆØ±Ù…Ø§Øªâ€¦ Ù‡Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ù‘Ø§Ù‡ ÙˆÙ†Ø¸Ø¨Ø·Ù‡).</small>

    <button id="uploadBtn">Ø±ÙØ¹ Ø§Ù„Ø´ÙŠØª ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡</button>

    <h3 style="margin-top:18px;margin-bottom:8px;font-size:14px;color:#111827;">Ø§Ù„Ù„ÙˆØ¬ / Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ­ØµÙ„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</h3>
    <div id="log"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDh7ofrYeZ_KWlk7NJmBuZw0NLm5xkNBks",
  authDomain: "mzj-ads.firebaseapp.com",
  projectId: "mzj-ads",
  storageBucket: "mzj-ads.firebasestorage.app",
  messagingSenderId: "830896442086",
  appId: "1:830896442086:web:f42e7329bd3a8400a90927"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const monthInput = document.getElementById("month");
const fileInput  = document.getElementById("file");
const uploadBtn  = document.getElementById("uploadBtn");
const logBox     = document.getElementById("log");
const platformSel= document.getElementById("platform");

function log(txt){
  const now = new Date();
  const time = now.toISOString().split("T")[1].split(".")[0];
  logBox.textContent += "["+time+"] "+txt+"\\n";
  logBox.scrollTop = logBox.scrollHeight;
  console.log(txt);
}

async function readFileSmart(file){
  const buffer = await file.arrayBuffer();
  const name   = file.name.toLowerCase();
  const isCsv  = name.endsWith(".csv");

  if(!isCsv){
    log("ğŸ“„ Ù…Ù„Ù Excel (XLS/XLSX) â€” Ù‚Ø±Ø§Ø¡Ø© Ø¨ØµÙŠØºØ© array");
    const wb = XLSX.read(buffer,{ type:"array" });
    const sheet = wb.SheetNames[0];
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval:"", raw:true });
    return rows;
  }

  const bytes = new Uint8Array(buffer);
  let text;
  log("ğŸ“„ Ù…Ù„Ù CSV â€” Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ØªØ±Ù…ÙŠØ² (UTF-8 / UTF-16 / Windows-1256)...");

  if(bytes[0] === 0xFF && bytes[1] === 0xFE){
    log("ğŸ” UTF-16 LE");
    text = new TextDecoder("utf-16le").decode(buffer);
  }else if(bytes[0] === 0xFE && bytes[1] === 0xFF){
    log("ğŸ” UTF-16 BE");
    text = new TextDecoder("utf-16be").decode(buffer);
  }else{
    try{
      log("ğŸ” ØªØ¬Ø±Ø¨Ø© UTF-8");
      text = new TextDecoder("utf-8").decode(buffer);
      if(text.includes("Ã™") || text.includes("Ã˜") || text.includes("Ã")){
        log("âš  Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø§ÙŠØ¸â€¦ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© windows-1256");
        text = new TextDecoder("windows-1256").decode(buffer);
      }
    }catch(e){
      log("âš  ÙØ´Ù„ UTF-8â€¦ Ø§Ø³ØªØ®Ø¯Ø§Ù… windows-1256");
      text = new TextDecoder("windows-1256").decode(buffer);
    }
  }

  const wb = XLSX.read(text,{ type:"string" });
  const sheet = wb.SheetNames[0];
  const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval:"", raw:true });
  return rows;
}

function getField(row,names){
  for(const n of names){
    if(Object.prototype.hasOwnProperty.call(row,n) && row[n] !== "") return row[n];
  }
  return "";
}

function getNumField(row,names){
  const v = getField(row,names);
  if(v === "" || v === null || v === undefined) return null;
  const n = Number(v);
  return isNaN(n) ? null : n;
}

uploadBtn.onclick = async () => {
  const month = monthInput.value;
  const file  = fileInput.files[0];
  const plat  = platformSel.value;

  if(!month){ alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙŠØ§ Ø®Ø§Ù„ ğŸ™"); return; }
  if(!file){ alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø£ÙˆÙ„ ğŸ™"); return; }

  uploadBtn.disabled = true;
  logBox.textContent = "";
  log("ğŸš€ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´ÙŠØª Ø§Ù„Ù…Ù†ØµØ§Øª Ù„Ù„Ø´Ù‡Ø±: "+month);
  log("ğŸ“ Ø§Ù„Ù…Ù„Ù: "+file.name+" | Ø§Ù„Ù…Ù†ØµØ©: "+plat);

  try{
    const rows = await readFileSmart(file);
    log("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: "+rows.length);
    if(rows.length === 0){
      log("âš  Ø§Ù„Ù…Ù„Ù ÙØ§Ø¶ÙŠ.");
      uploadBtn.disabled = false;
      return;
    }

    const coll = collection(db,"analytics",month,"platforms_raw");
    let ok=0,fail=0;

    for(const r of rows){
      try{
        const campaign = getField(r,["Campaign Name","Campaign name","Campaign","Ø§Ù„Ø­Ù…Ù„Ø©"]);
        const adset    = getField(r,["Ad set name","Ad Set Name","Ad Squad","Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"]);
        const ad       = getField(r,["Ad Name","Ad name","Ad","Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"]);

        const spend  = getNumField(r,["Amount spent (SAR)","Amount spent","Spend","Ø§Ù„Ø¥Ù†ÙØ§Ù‚"]);
        const impr   = getNumField(r,["Impressions","Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹Ø§Øª","Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±"]);
        const clicks = getNumField(r,["Clicks","Link clicks","Swipe Ups","Swipe ups","Ø§Ù„Ù†Ù‚Ø±Ø§Øª"]);
        const ctr    = getNumField(r,["CTR (%)","CTR","Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø±"]);
        const cpc    = getNumField(r,["CPC (cost per link click)","CPC","Cost per click (all)"]);
        const cpm    = getNumField(r,["CPM (cost per 1,000 impressions)","CPM","eCPM"]);
        const leads  = getNumField(r,["Leads","Results","Ø§Ù„Ù†ØªØ§Ø¦Ø¬","Conversions"]);
        const cpl    = getNumField(r,["Cost per result","Cost per results","Cost per Lead","CPL","eCPL"]);
        let resultType = getField(r,["Result Type","Result indicator","Ù‡Ø¯Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©"]);

        const payload = {
          Platform: plat,
          CampaignName: campaign || "(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ø­Ù…Ù„Ø©)",
          AdSetName: adset || "",
          AdName: ad || "",
          Spend: spend ?? 0,
          Impressions: impr ?? 0,
          Clicks: clicks ?? 0,
          CTR: ctr,
          CPC: cpc,
          CPM: cpm,
          Leads: leads ?? 0,
          CostPerLead: cpl,
          ResultType: resultType || "",
          monthKey: month,
          source: "platforms-upload",
          createdAt: serverTimestamp()
        };

        await addDoc(coll,payload);
        ok++;
      }catch(e){
        fail++;
        log("âŒ Ø®Ø·Ø£ ÙÙŠ ØµÙ: "+e.message);
      }
    }

    log("âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹.");
    log("âœ” ØµÙÙˆÙ Ù†Ø§Ø¬Ø­Ø©: "+ok+" | âŒ ØµÙÙˆÙ ÙØ§Ø´Ù„Ø©: "+fail);

  }catch(err){
    console.error(err);
    log("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: "+err.message);
  }finally{
    uploadBtn.disabled = false;
  }
};
</script>
</body>
</html>
