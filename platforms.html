
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>MZJ Ads â€” Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª v2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tajawal Font -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- XLSX & PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --radius:18px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top left,#fef3c7,#f5ebe2 40%,#ffffff 80%);
      color:var(--text);
    }

    /* Top unified bar */
    .mzj-topbar{
      position:sticky;
      top:0;
      z-index:999;
      background:#3e2420;
      color:#f9fafb;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
    }
    .mzj-topbar-inner{
      max-width:1350px;
      margin:0 auto;
      padding:10px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .mzj-topbar-title{font-size:16px;font-weight:800;}
    .mzj-topbar-sub{font-size:12px;opacity:.8;}
    .mzj-topbar-nav{display:flex;gap:10px;flex-wrap:wrap;}
    .mzj-topbar-link{
      padding:5px 14px;
      font-size:12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.5);
      color:#fff;
      text-decoration:none;
      transition:.2s;
    }
    .mzj-topbar-link:hover{
      background:#facc15;
      color:#1f2937;
      border-color:#facc15;
    }

    .app{
      max-width:1150px;
      margin:18px auto 24px;
      padding:0 16px 24px;
    }

    .card{
      background:#fff8ef;
      border-radius:var(--radius);
      border:1px solid rgba(226,232,240,0.9);
      box-shadow:0 14px 32px rgba(15,23,42,0.12);
      padding:14px 16px 16px;
      margin-bottom:14px;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title{
      font-size:15px;
      font-weight:800;
      color:var(--brown);
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
    }

    .grid{
      display:grid;
      gap:12px;
    }
    @media (min-width: 880px){
      .grid-2{
        grid-template-columns:2.2fr 1.3fr;
      }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }
    .field label{
      font-weight:600;
      color:var(--brown);
    }
    .field small{
      font-size:11px;
      color:var(--muted);
    }
    .field input[type="month"],
    .field select,
    .field input[type="file"]{
      padding:7px 11px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-family:inherit;
      font-size:13px;
      outline:none;
      transition:.12s ease border-color,.12s ease box-shadow,.12s ease background;
    }
    .field input[type="file"]{
      padding:6px 11px;
      border-radius:14px;
    }
    .field input[type="month"]:focus,
    .field select:focus,
    .field input[type="file"]:focus{
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,0.5);
      background:#ffffff;
    }

    .btn{
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.12s ease all;
    }
    .btn-primary{
      background:var(--brown);
      color:#ffffff;
      box-shadow:0 10px 24px rgba(62,36,32,0.55);
    }
    .btn-primary:not(:disabled):hover{
      background:#2e1714;
      transform:translateY(-1px);
      box-shadow:0 16px 32px rgba(15,23,42,0.6);
    }
    .btn-primary:disabled{
      opacity:.6;
      cursor:not-allowed;
      box-shadow:none;
      transform:none;
    }
    .btn-ghost{
      background:transparent;
      color:var(--brown);
      border:1px dashed rgba(148,163,184,0.9);
    }
    .btn-ghost:hover{
      border-style:solid;
      background:#f9fafb;
    }

    .status-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      font-size:11px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 9px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,0.8);
    }
    .pill-ok{
      background:#ecfdf3;
      border-color:#bbf7d0;
      color:#166534;
    }
    .pill-bad{
      background:#fef2f2;
      border-color:#fecaca;
      color:#991b1b;
    }
    .pill-dot{
      width:7px;
      height:7px;
      border-radius:999px;
      background:currentColor;
    }

    .log-area{
      max-height:260px;
      overflow:auto;
      padding:8px 10px;
      border-radius:12px;
      background:#f9fafb;
      border:1px dashed #e2e8f0;
      font-size:11px;
      line-height:1.7;
      direction:ltr;
      text-align:left;
    }
    .log-line-ok{color:#16a34a;}
    .log-line-warn{color:#ca8a04;}
    .log-line-err{color:#dc2626;}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:#eff6ff;
      color:#1d4ed8;
      margin-inline-start:4px;
    }

    .fake-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:8px;
    }
    .fake-table th,
    .fake-table td{
      padding:4px 6px;
      border-bottom:1px solid #e2e8f0;
      white-space:nowrap;
      text-align:right;
    }
    .fake-table th{
      background:#f8fafc;
      font-weight:700;
      color:#475569;
    }

    .hint{
      font-size:11px;
      color:#94a3b8;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="mzj-topbar">
    <div class="mzj-topbar-inner">
      <div>
        <div class="mzj-topbar-title">MZJ Ads Workspace</div>
        <div class="mzj-topbar-sub">Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ§Øª (META / TikTok / Snap) â€” Ù†Ø³Ø®Ø© v2 Ø§Ù„Ù†Ø¸ÙŠÙØ©</div>
      </div>
      <nav class="mzj-topbar-nav">
        <a href="dashboard.html" class="mzj-topbar-link">Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
        <a href="platforms.html" class="mzj-topbar-link" style="background:#facc15;color:#1f2937;border-color:#facc15;">Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª</a>
        <a href="messages.html" class="mzj-topbar-link">Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a>
      </nav>
    </div>
  </div>

  <main class="app">
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª v2</div>
          <div class="card-sub">
            Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ù†ØµØ© + Ù†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª + Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ ÙˆØ§Ø±ÙØ¹ Ù…Ù„Ù CSV/Excel. Ø§Ù„Ù†Ø¸Ø§Ù… Ù‡ÙŠÙ‚Ø±Ø£ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆÙŠØ­ÙØ¸
            <span class="badge">raw + norm</span>
            ÙÙŠ Firestore ØªØ­Øª
            <code>analytics / {month} / {platform_raw}</code>.
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="grid" style="gap:10px;">
          <div class="field">
            <label for="platformSelect">Ø§Ù„Ù…Ù†ØµØ©</label>
            <select id="platformSelect">
              <option value="meta">META (ÙÙŠØ³Ø¨ÙˆÙƒ + Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…)</option>
              <option value="tiktok">TikTok</option>
              <option value="snap">Snapchat</option>
            </select>
            <small>Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù„ÙŠ Ø§Ù„Ø´ÙŠØª ØµØ§Ø¯Ø± Ù…Ù†Ù‡Ø§.</small>
          </div>

          <div class="field">
            <label for="sheetTypeSelect">Ù†ÙˆØ¹ Ø§Ù„Ø´ÙŠØª / Ø§Ù„Ù‡Ø¯Ù</label>
            <select id="sheetTypeSelect">
              <option value="messages">Ø±Ø³Ø§Ø¦Ù„ / Ù…Ø­Ø§Ø¯Ø«Ø§Øª</option>
              <option value="leads">Ù„ÙŠØ¯Ø² / Ù†Ù…Ø§Ø°Ø¬</option>
              <option value="views">Ù…Ø´Ø§Ù‡Ø¯Ø§Øª / Awareness</option>
              <option value="engagement">ØªÙØ§Ø¹Ù„ / Engagement</option>
            </select>
            <small>Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙ‚Ø· Ù„ØªØ³Ù…ÙŠØ© Ø§Ù„Ù€ KPIs ÙÙŠ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯.</small>
          </div>

          <div class="field">
            <label for="monthInput">Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <input type="month" id="monthInput" />
            <small>ÙŠØ®Ø²Ù† ØªØ­Øª Ù…Ø³Ø§Ø± analytics / YYYY-MM.</small>
          </div>

          <div class="field">
            <label for="fileInput">Ù…Ù„Ù Ø§Ù„Ø´ÙŠØª (CSV Ø£Ùˆ Excel)</label>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" />
            <small>Ø§Ù„Ø¯Ø§ØªØ§ Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† ÙƒØ§Ù…Ù„Ø© (Ø§Ù„Ù‡ÙŠØ¯Ø± + ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ).</small>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;">
            <button id="uploadBtn" class="btn btn-primary">
              Ø±ÙØ¹ Ø§Ù„Ø´ÙŠØª ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Firestore
            </button>
            <button id="testParseBtn" class="btn btn-ghost">
              ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ 5 ØµÙÙˆÙ ÙÙ‚Ø·
            </button>
          </div>

          <div class="hint">
            Ù„Ùˆ Ø­ØµÙ„ Ø£ÙŠ ErrorØŒ Ø¨Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„ÙŠ ØªØ­Øª.  
            ÙƒÙ„ ØµÙ Ø¨ÙŠØªØ®Ø²Ù† Ø¨Ù€ raw (ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©) Ùˆ norm (Ø£Ø¹Ù…Ø¯Ø© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯).
          </div>
        </div>

        <div>
          <div class="field">
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹</label>
            <div id="statusPill" class="pill">
              <span class="pill-dot"></span>
              <span id="statusText">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ§Ù„Ø´Ù‡Ø±.</span>
            </div>
          </div>

          <div class="field" style="margin-top:8px;">
            <label>Preview Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø£ÙˆÙ„ 6 Ø£Ø¹Ù…Ø¯Ø© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±)</label>
            <table class="fake-table" id="headerPreview">
              <thead>
                <tr><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 1</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 2</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 3</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 4</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 5</th><th>Ø§Ù„Ø¹Ù…ÙˆØ¯ 6</th></tr>
              </thead>
              <tbody>
                <tr><td colspan="6" style="text-align:center;color:#94a3b8;">Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ù…Ù„Ù Ù…Ø±ÙÙˆØ¹.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="field" style="margin-top:10px;">
        <label>Log / Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</label>
        <div id="logArea" class="log-area">
          <!-- log lines -->
        </div>
      </div>

      <div class="status-line">
        <div>ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ Ù‡ØªØªØ®Ø²Ù† Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© + Ù†Ø³Ø®Ø© Norm Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯.</div>
        <div>Project: <code>mzj-ads / analytics</code></div>
      </div>
    </section>
  </main>

  <script>
    // ===== Firebase Init (compat) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDh7ofrYeZ_KWlk7NJmBuZw0NLm5xkNBks",
      authDomain: "mzj-ads.firebaseapp.com",
      projectId: "mzj-ads",
      storageBucket: "mzj-ads.firebasestorage.app",
      messagingSenderId: "830896442086",
      appId: "1:830896442086:web:f42e7329bd3a8400a90927"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Helpers =====
    const platformSelect   = document.getElementById("platformSelect");
    const sheetTypeSelect  = document.getElementById("sheetTypeSelect");
    const monthInput       = document.getElementById("monthInput");
    const fileInput        = document.getElementById("fileInput");
    const uploadBtn        = document.getElementById("uploadBtn");
    const testParseBtn     = document.getElementById("testParseBtn");
    const statusPill       = document.getElementById("statusPill");
    const statusText       = document.getElementById("statusText");
    const logArea          = document.getElementById("logArea");
    const headerPreviewTbl = document.getElementById("headerPreview").querySelector("tbody");

    function log(message, type="ok"){
      const line = document.createElement("div");
      if(type==="ok")   line.className = "log-line-ok";
      if(type==="warn") line.className = "log-line-warn";
      if(type==="err")  line.className = "log-line-err";
      line.textContent = message;
      logArea.appendChild(line);
      logArea.scrollTop = logArea.scrollHeight;
    }

    function setStatus(text, type="ok"){
      statusText.textContent = text;
      statusPill.classList.remove("pill-ok","pill-bad");
      if(type==="ok"){
        statusPill.classList.add("pill-ok");
      }else if(type==="bad"){
        statusPill.classList.add("pill-bad");
      }
    }

    function toNumber(val){
      if(val === null || val === undefined) return 0;
      if(typeof val === "number") return val;
      const cleaned = String(val).replace(/,/g,"").trim();
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }

    function pickFirst(row, candidates){
      for(const key of candidates){
        if(key in row && row[key] !== "" && row[key] !== null && row[key] !== undefined){
          return row[key];
        }
      }
      return null;
    }

    // ===== Column Maps =====
    const META_COLUMN_MAP = {
      spend: [
        "Amount spent (SAR)",
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†ÙØ§Ù‚Ù‡ (SAR)",
        "Amount spent"
      ],
      impressions: [
        "Impressions",
        "Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±"
      ],
      reach: [
        "Reach",
        "Ø§Ù„ÙˆØµÙˆÙ„"
      ],
      results: [
        "Results",
        "Ø§Ù„Ù†ØªØ§Ø¦Ø¬"
      ],
      costPerResult: [
        "Cost per results",
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø©"
      ],
      adSetName: [
        "Ad set name",
        "Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"
      ],
      campaignName: [
        "Campaign name",
        "Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      adName: [
        "Ad name",
        "Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ]
    };

    const TIKTOK_COLUMN_MAP = {
      adGroupName: [
        "Ad group name"
      ],
      spend: [
        "Cost",
        "Total cost"
      ],
      impressions: [
        "Impressions"
      ],
      clicks: [
        "Clicks (destination)",
        "Clicks"
      ],
      ctr: [
        "CTR (destination)",
        "Click-through rate"
      ],
      results: [
        "Results"
      ],
      costPerResult: [
        "Cost per result"
      ],
      resultRate: [
        "Result rate"
      ],
      conversionsMmp: [
        "Conversions [MMP]"
      ],
      conversionsSan: [
        "Conversions [SAN]"
      ],
      costPerConversionMmp: [
        "Cost per conversion [MMP]"
      ],
      costPerConversionSan: [
        "Cost per conversion [SAN]"
      ],
      cvrMmp: [
        "Conversion rate (CVR) [MMP]"
      ],
      cvrSan: [
        "Conversion rate (CVR) [SAN]"
      ],
      deepFunnelResult: [
        "Deep funnel result"
      ],
      costPerDeepFunnelResult: [
        "Cost per deep funnel result"
      ],
      deepFunnelRate: [
        "Deep funnel result rate"
      ]
    };

    const SNAP_COLUMN_MAP = {
      campaignId: [
        "Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      campaignName: [
        "Ø§Ø³Ù… Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      adSetId: [
        "Ø±Ù…Ø² ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"
      ],
      adSetName: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ø§Ø³Ù…"
      ],
      adSetStatus: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©"
      ],
      dailyBudget: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©"
      ],
      lifetimeBudget: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø·ÙˆØ§Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ù…Ù„Ø©"
      ],
      adSetGoal: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø§Ù„Ù‡Ø¯Ù"
      ],
      bid: [
        "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠØ© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±"
      ],
      spend: [
        "Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†ÙØ§Ù‚Ù‡"
      ],
      results: [
        "Ø§Ù„Ù†ØªÙŠØ¬Ø©"
      ],
      resultType: [
        "Ù†ÙˆØ¹ Ø§Ù„Ù†ØªÙŠØ¬Ø©"
      ],
      costPerResult: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù†ØªÙŠØ¬Ø©"
      ],
      costPerResultType: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ù†ØªÙŠØ¬Ø©"
      ],
      impressions: [
        "Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©"
      ],
      eCPM: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ù„ÙƒÙ„ Ø£Ù„Ù Ø¸Ù‡ÙˆØ± (eCPM)"
      ],
      clicks: [
        "Ø§Ù„Ù†Ù‚Ø±Ø§Øª"
      ],
      eCPC: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù„ÙƒÙ„ Ù†Ù‚Ø±Ø© (eCPC)"
      ],
      installs: [
        "Ø¹Ù…Ù„ÙŠØ§Øª ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
      ],
      costPerInstall: [
        "Ø§Ù„ØªÙƒÙ„ÙØ© Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ«Ø¨ÙŠØª"
      ],
      installRate: [
        "Ù…Ø¹Ø¯Ù„ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
      ],
      adId: [
        "Ø±Ù…Ø² ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ],
      adName: [
        "Ø§Ø³Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ],
      adStatus: [
        "Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø©"
      ],
      adType: [
        "Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
      ]
    };

    function buildNormForMeta(row, sheetType, monthKey){
      const spend       = toNumber(pickFirst(row, META_COLUMN_MAP.spend));
      const impressions = toNumber(pickFirst(row, META_COLUMN_MAP.impressions));
      const reach       = toNumber(pickFirst(row, META_COLUMN_MAP.reach));
      const results     = toNumber(pickFirst(row, META_COLUMN_MAP.results));
      const costPerResult = toNumber(pickFirst(row, META_COLUMN_MAP.costPerResult));
      const adSetName   = pickFirst(row, META_COLUMN_MAP.adSetName);
      const campaignName= pickFirst(row, META_COLUMN_MAP.campaignName);
      const adName      = pickFirst(row, META_COLUMN_MAP.adName);

      const ctr         = impressions > 0 ? (results > 0 ? (results / impressions) * 100 : null) : null;
      const cpr         = results > 0 ? spend / results : null;

      return {
        platform: "meta",
        sheetType,
        monthKey,
        campaignName: campaignName || null,
        adSetName: adSetName || null,
        adName: adName || null,
        spend,
        impressions,
        reach,
        results,
        costPerResult: costPerResult || cpr,
        ctr,
        cpc: null // Ù…Ù…ÙƒÙ† Ù†Ø²ÙˆØ¯ Ù„Ùˆ Ø¹Ù†Ø¯Ù†Ø§ Clicks ÙÙŠ Ø´ÙŠØªØ§Øª Ø£Ø®Ø±Ù‰
      };
    }

    function buildNormForTikTok(row, sheetType, monthKey){
      const spend       = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.spend));
      const impressions = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.impressions));
      const clicks      = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.clicks));
      const ctrRaw      = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.ctr));
      const results     = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.results));
      const costPerRes  = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.costPerResult));
      const adGroupName = pickFirst(row, TIKTOK_COLUMN_MAP.adGroupName);

      const ctr = ctrRaw || (impressions > 0 && clicks > 0 ? (clicks / impressions) * 100 : null);
      const cpc = clicks > 0 ? spend / clicks : null;
      const cpr = results > 0 ? spend / results : null;

      const convMmp = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.conversionsMmp));
      const convSan = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.conversionsSan));
      const cvrMmp  = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.cvrMmp));
      const cvrSan  = toNumber(pickFirst(row, TIKTOK_COLUMN_MAP.cvrSan));

      return {
        platform: "tiktok",
        sheetType,
        monthKey,
        adGroupName: adGroupName || null,
        campaignName: null,
        adName: null,
        spend,
        impressions,
        clicks,
        ctr,
        results,
        costPerResult: costPerRes || cpr,
        cpc,
        conversionsMmp: convMmp || null,
        conversionsSan: convSan || null,
        cvrMmp: cvrMmp || null,
        cvrSan: cvrSan || null
      };
    }

    function buildNormForSnap(row, sheetType, monthKey){
      const spend       = toNumber(pickFirst(row, SNAP_COLUMN_MAP.spend));
      const impressions = toNumber(pickFirst(row, SNAP_COLUMN_MAP.impressions));
      const clicks      = toNumber(pickFirst(row, SNAP_COLUMN_MAP.clicks));
      const results     = toNumber(pickFirst(row, SNAP_COLUMN_MAP.results));
      const costPerRes  = toNumber(pickFirst(row, SNAP_COLUMN_MAP.costPerResult));
      const campaignId  = pickFirst(row, SNAP_COLUMN_MAP.campaignId);
      const campaignName= pickFirst(row, SNAP_COLUMN_MAP.campaignName);
      const adSetName   = pickFirst(row, SNAP_COLUMN_MAP.adSetName);
      const adName      = pickFirst(row, SNAP_COLUMN_MAP.adName);

      const ctr = impressions > 0 && clicks > 0 ? (clicks / impressions) * 100 : null;
      const cpc = clicks > 0 ? spend / clicks : null;
      const cpr = results > 0 ? spend / results : null;

      return {
        platform: "snap",
        sheetType,
        monthKey,
        campaignId: campaignId || null,
        campaignName: campaignName || null,
        adSetName: adSetName || null,
        adName: adName || null,
        spend,
        impressions,
        clicks,
        results,
        costPerResult: costPerRes || cpr,
        ctr,
        cpc
      };
    }

    function buildNormRow(row, platform, sheetType, monthKey){
      if(platform === "meta"){
        return buildNormForMeta(row, sheetType, monthKey);
      }
      if(platform === "tiktok"){
        return buildNormForTikTok(row, sheetType, monthKey);
      }
      if(platform === "snap"){
        return buildNormForSnap(row, sheetType, monthKey);
      }
      return { platform, sheetType, monthKey };
    }

    function getCollectionName(platform){
      if(platform === "meta")   return "meta_raw";
      if(platform === "tiktok") return "tiktok_raw";
      if(platform === "snap")   return "snap_raw";
      return "other_raw";
    }

    function updateHeaderPreview(headers){
      headerPreviewTbl.innerHTML = "";
      if(!headers || !headers.length){
        headerPreviewTbl.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù.</td></tr>';
        return;
      }
      const row = document.createElement("tr");
      for(let i=0;i<6;i++){
        const td = document.createElement("td");
        td.textContent = headers[i] || "-";
        row.appendChild(td);
      }
      headerPreviewTbl.appendChild(row);
    }

    function detectFileType(file){
      const name = file.name.toLowerCase();
      if(name.endsWith(".csv")) return "csv";
      if(name.endsWith(".xlsx") || name.endsWith(".xls")) return "excel";
      return "unknown";
    }

    function parseFile(file){
      return new Promise((resolve, reject)=>{
        const type = detectFileType(file);
        if(type === "csv"){
          Papa.parse(file,{
            header:true,
            skipEmptyLines:true,
            complete:(res)=>{
              resolve(res.data);
            },
            error:(err)=>reject(err)
          });
        }else if(type === "excel"){
          const reader = new FileReader();
          reader.onload = (e)=>{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data,{type:"array"});
            const sheetName = workbook.SheetNames[0];
            const ws = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(ws,{defval:""});
            resolve(json);
          };
          reader.onerror = (e)=>reject(e);
          reader.readAsArrayBuffer(file);
        }else{
          reject(new Error("Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ Excel."));
        }
      });
    }

    async function handleTestParse(){
      const file = fileInput.files[0];
      if(!file){
        alert("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ Ø®Ø§Ù„.");
        return;
      }
      logArea.innerHTML = "";
      setStatus("Ø¬Ø§Ø±ÙŠ ØªØ¬Ø±Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ùâ€¦","ok");
      log("â³ Test Parse: Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø£ÙˆÙ„ 5 ØµÙÙˆÙâ€¦","warn");

      try{
        const rows = await parseFile(file);
        if(!rows.length){
          setStatus("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙÙˆÙ.","bad");
          log("âš  Ø§Ù„Ù…Ù„Ù ÙØ§Ø¶ÙŠ Ø£Ùˆ Ù…ÙÙŠÙ‡ÙˆØ´ Ø¯Ø§ØªØ§.","warn");
          return;
        }
        const headers = Object.keys(rows[0]);
        updateHeaderPreview(headers);
        log(`âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© ${rows.length} ØµÙ. Ø£ÙˆÙ„ 5 ØµÙÙˆÙ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:`,`ok");
        rows.slice(0,5).forEach((r,idx)=>{
          log(`#${idx+1}: `+JSON.stringify(r), "ok");
        });
        setStatus("ØªÙ…Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­. Ù„Ùˆ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø¸Ø¨ÙˆØ·ØŒ Ø¯ÙˆØ³ Ø±ÙØ¹ Ø§Ù„Ø´ÙŠØª.","ok");
      }catch(err){
        console.error(err);
        log("âŒ Error Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: "+err.message,"err");
        setStatus("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù…Ø§Øª.","bad");
      }
    }

    async function handleUpload(){
      const file     = fileInput.files[0];
      const platform = platformSelect.value;
      const sheetType= sheetTypeSelect.value;
      const monthVal = monthInput.value;

      if(!file){
        alert("Ø§Ø®ØªØ§Ø± Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ Ø®Ø§Ù„.");
        return;
      }
      if(!monthVal){
        alert("Ø§Ø®ØªØ§Ø± Ø´Ù‡Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ§ Ø®Ø§Ù„.");
        return;
      }

      logArea.innerHTML = "";
      setStatus("Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØªØ¬Ù‡ÙŠØ²Ù‡ Ù„Ù„Ø±ÙØ¹â€¦","ok");
      uploadBtn.disabled   = true;
      testParseBtn.disabled= true;

      try{
        const rows = await parseFile(file);
        if(!rows.length){
          setStatus("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙÙˆÙ.","bad");
          log("âš  Ø§Ù„Ù…Ù„Ù ÙØ§Ø¶ÙŠ Ø£Ùˆ Ù…ÙÙŠÙ‡ÙˆØ´ Ø¯Ø§ØªØ§.","warn");
          uploadBtn.disabled   = false;
          testParseBtn.disabled= false;
          return;
        }

        const headers = Object.keys(rows[0]);
        updateHeaderPreview(headers);
        log(`ğŸ“„ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù: ${rows.length}`,"ok");

        const monthKey = monthVal;
        const colName  = getCollectionName(platform);

        let successCount = 0;
        let failCount    = 0;

        for(let i=0;i<rows.length;i++){
          const rawRow = rows[i];
          // ØªØ®Ø·ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹
          const values = Object.values(rawRow || {});
          const allEmpty = values.every(v => v === null || v === undefined || String(v).trim() === "");
          if(allEmpty){
            continue;
          }

          const norm = buildNormRow(rawRow, platform, sheetType, monthKey);
          const docData = {
            raw: rawRow,
            norm,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          try{
            await db.collection("analytics")
              .doc(monthKey)
              .collection(colName)
              .add(docData);
            successCount++;
            if(successCount <= 3){
              log(`âœ… ØµÙ ${i+1} ØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ù†Ø¬Ø§Ø­.`, "ok");
            }
          }catch(err){
            failCount++;
            console.error(err);
            if(failCount <= 3){
              log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ ${i+1}: ${err.message}`,"err");
            }
          }
        }

        log(`ğŸ¯ ØªÙ… Ø§Ù„Ø¥Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø±ÙØ¹: Ù†Ø§Ø¬Ø­ = ${successCount} | ÙØ§Ø´Ù„ = ${failCount}`,"ok");
        if(successCount > 0 && failCount === 0){
          setStatus(`ØªÙ… Ø±ÙØ¹ ${successCount} ØµÙ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ analytics/${monthKey}/${colName}.`,"ok");
        }else if(successCount > 0){
          setStatus(`ØªÙ… Ø±ÙØ¹ ${successCount} ØµÙØŒ Ù…Ø¹ ${failCount} Ø®Ø·Ø£. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Log.`,"bad");
        }else{
          setStatus("Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ Ø£ÙŠ ØµÙ. Ø±Ø§Ø¬Ø¹ ÙÙˆØ±Ù…Ø§Øª Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ù€ Log.","bad");
        }

      }catch(err){
        console.error(err);
        log("âŒ Error Ø¹Ø§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: "+err.message,"err");
        setStatus("ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø£Ùˆ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Log.","bad");
      }finally{
        uploadBtn.disabled   = false;
        testParseBtn.disabled= false;
      }
    }

    uploadBtn.addEventListener("click", handleUpload);
    testParseBtn.addEventListener("click", handleTestParse);

    (function presetMonth(){
      const now = new Date();
      const y   = now.getFullYear();
      const m   = String(now.getMonth()+1).padStart(2,"0");
      monthInput.value = `${y}-${m}`;
    })();
  </script>
</body>
</html>
