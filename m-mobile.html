<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MZJ Ads â€” Ø±ÙØ¹ Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Mobile)</title>

  <!-- Tajawal Font -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --muted:#6b7280;
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Tajawal',sans-serif;
    }

    body{
      min-height:100vh;
      background:#f5eee8;
      display:flex;
      flex-direction:column;
    }

    /* Top bar */
    .topbar{
      background:#3e2420;
      color:#f9fafb;
      padding:10px 14px;
      box-shadow:0 8px 22px rgba(0,0,0,0.55);
    }
    .topbar-title{
      font-size:15px;
      font-weight:800;
    }
    .topbar-sub{
      font-size:11px;
      opacity:.9;
    }

    /* Main app */
    .app{
      flex:1;
      padding:14px 14px 70px;
    }

    .tag{
      display:inline-flex;
      gap:6px;
      align-items:center;
      font-size:11px;
      color:#4b5563;
      margin-bottom:8px;
    }
    .tag-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#0ea5e9;
    }

    .card{
      background:#fff;
      border-radius:14px;
      padding:16px 14px;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
      border:1px solid #e5e7eb;
      max-width:520px;
      margin:0 auto;
    }

    h2{
      margin-top:0;
      font-size:16px;
      color:var(--brown);
    }

    label{
      font-weight:600;
      margin-bottom:4px;
      display:block;
      color:var(--brown);
      font-size:13px;
    }

    input,select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #ddd;
      margin-bottom:12px;
      font-size:13px;
      background:#fafafa;
      outline:none;
    }

    small{
      display:block;
      font-size:11px;
      color:var(--muted);
      margin-top:-6px;
      margin-bottom:10px;
    }

    button{
      width:100%;
      padding:10px 0;
      border:none;
      border-radius:999px;
      background:#3e2420;
      color:#fff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(62,36,32,.35);
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    button:not(:disabled):active{
      transform:scale(0.97);
    }

    h3{
      margin-top:18px;
      margin-bottom:8px;
      font-size:14px;
      color:#111827;
    }

    #log{
      background:#020617;
      color:#e5e7eb;
      padding:10px;
      border-radius:10px;
      font-size:11px;
      height:220px;
      overflow:auto;
      white-space:pre-wrap;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Bottom nav */
    .bottom-nav{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      height:56px;
      background:#111827;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:space-around;
      font-size:11px;
      z-index:20;
    }
    .nav-item{
      text-align:center;
      opacity:.8;
      cursor:pointer;
    }
    .nav-item span.icon{
      display:block;
      font-size:16px;
      margin-bottom:2px;
    }
    .nav-item.active{
      opacity:1;
      color:#facc15;
      font-weight:700;
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-title">MZJ Ads Workspace</div>
    <div class="topbar-sub">Ø±ÙØ¹ Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Meta / TikTok / Snap)</div>
  </header>

  <!-- Main content -->
  <main class="app">
    <div class="card">
      <div class="tag">
        <span class="tag-dot"></span>
        <span>MZJ Ads â€” Ø±ÙØ¹ Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Messages Campaigns)</span>
      </div>

      <h2>Ø±ÙØ¹ Ø´ÙŠØª Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h2>

      <label>Ø§Ù„Ø´Ù‡Ø±</label>
      <input type="month" id="month"/>
      <small>Ù‡ÙŠØªØ®Ø²Ù† ÙÙŠ: analytics / {"{Ø§Ù„Ø´Ù‡Ø±}"} / messages_raw</small>

      <label>Ø§Ù„Ù…Ù†ØµØ©</label>
      <select id="platform">
        <option value="Meta">Meta (Facebook / Instagram)</option>
        <option value="TikTok">TikTok</option>
        <option value="Snapchat">Snapchat</option>
        <option value="Other">Ù…Ù†ØµØ© Ø£Ø®Ø±Ù‰</option>
      </select>

      <label>Ù…Ù„Ù Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (CSV Ø£Ùˆ Excel)</label>
      <input type="file" id="file" accept=".csv,.xlsx,.xls"/>
      <small>ÙŠÙÙØ¶Ù‘Ù„ ÙŠÙƒÙˆÙ† ÙÙŠÙ‡: Campaign / Ad Set / Spend / Impressions / Results (Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª) / Cost per Result.</small>

      <button id="uploadBtn">Ø±ÙØ¹ Ø§Ù„Ø´ÙŠØª ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡</button>

      <h3>Ø§Ù„Ù„ÙˆØ¬ / Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ­ØµÙ„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</h3>
      <div id="log"></div>
    </div>
  </main>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <div class="nav-item" >
      <span class="icon">ğŸ“Š</span>
      Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    </div>
    <div class="nav-item">
      <span class="icon">ğŸ“¤</span>
      Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª
    </div>
    <div class="nav-item active">
      <span class="icon">ğŸ’¬</span>
      Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    </div>
  </nav>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDh7ofrYeZ_KWlk7NJmBuZw0NLm5xkNBks",
      authDomain: "mzj-ads.firebaseapp.com",
      projectId: "mzj-ads",
      storageBucket: "mzj-ads.firebasestorage.app",
      messagingSenderId: "830896442086",
      appId: "1:830896442086:web:f42e7329bd3a8400a90927"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const monthInput = document.getElementById("month");
    const fileInput  = document.getElementById("file");
    const uploadBtn  = document.getElementById("uploadBtn");
    const logBox     = document.getElementById("log");
    const platformSel= document.getElementById("platform");

    function log(txt){
      const now = new Date();
      const time = now.toISOString().split("T")[1].split(".")[0];
      logBox.textContent += "["+time+"] "+txt+"\\n";
      logBox.scrollTop = logBox.scrollHeight;
      console.log(txt);
    }

    async function readFileSmart(file){
      const buffer = await file.arrayBuffer();
      const name   = file.name.toLowerCase();
      const isCsv  = name.endsWith(".csv");

      if(!isCsv){
        log("ğŸ“„ Ù…Ù„Ù Excel (XLS/XLSX) â€” Ù‚Ø±Ø§Ø¡Ø© Ø¨ØµÙŠØºØ© array");
        const wb = XLSX.read(buffer,{ type:"array" });
        const sheet = wb.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval:"", raw:true });
        return rows;
      }

      const bytes = new Uint8Array(buffer);
      let text;
      log("ğŸ“„ Ù…Ù„Ù CSV â€” Ù…Ø­Ø§ÙˆÙ„Ø© Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ØªØ±Ù…ÙŠØ² (UTF-8 / UTF-16 / Windows-1256)...");

      if(bytes[0] === 0xFF && bytes[1] === 0xFE){
        log("ğŸ” UTF-16 LE");
        text = new TextDecoder("utf-16le").decode(buffer);
      }else if(bytes[0] === 0xFE && bytes[1] === 0xFF){
        log("ğŸ” UTF-16 BE");
        text = new TextDecoder("utf-16be").decode(buffer);
      }else{
        try{
          log("ğŸ” ØªØ¬Ø±Ø¨Ø© UTF-8");
          text = new TextDecoder("utf-8").decode(buffer);
          if(text.includes("Ã™") || text.includes("Ã˜") || text.includes("Ã")){
            log("âš  Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø§ÙŠØ¸â€¦ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© windows-1256");
            text = new TextDecoder("windows-1256").decode(buffer);
          }
        }catch(e){
          log("âš  ÙØ´Ù„ UTF-8â€¦ Ø§Ø³ØªØ®Ø¯Ø§Ù… windows-1256");
          text = new TextDecoder("windows-1256").decode(buffer);
        }
      }

      const wb = XLSX.read(text,{ type:"string" });
      const sheet = wb.SheetNames[0];
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval:"", raw:true });
      return rows;
    }

    function getField(row,names){
      for(const n of names){
        if(Object.prototype.hasOwnProperty.call(row,n) && row[n] !== "") return row[n];
      }
      return "";
    }

    function getNumField(row,names){
      const v = getField(row,names);
      if(v === "" || v === null || v === undefined) return null;
      const n = Number(v);
      return isNaN(n) ? null : n;
    }

    uploadBtn.onclick = async () => {
      const month = monthInput.value;
      const file  = fileInput.files[0];
      const plat  = platformSel.value;

      if(!month){ alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø´Ù‡Ø± ÙŠØ§ Ø®Ø§Ù„ ğŸ™"); return; }
      if(!file){ alert("Ø§Ø®ØªØ§Ø± Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø£ÙˆÙ„ ğŸ™"); return; }

      uploadBtn.disabled = true;
      logBox.textContent = "";
      log("ğŸš€ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´ÙŠØª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø´Ù‡Ø±: "+month);
      log("ğŸ“ Ø§Ù„Ù…Ù„Ù: "+file.name+" | Ø§Ù„Ù…Ù†ØµØ©: "+plat);

      try{
        const rows = await readFileSmart(file);
        log("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©: "+rows.length);
        if(rows.length === 0){
          log("âš  Ø§Ù„Ù…Ù„Ù ÙØ§Ø¶ÙŠ.");
          uploadBtn.disabled = false;
          return;
        }

        const coll = collection(db,"analytics",month,"messages_raw");
        let ok=0,fail=0;

        for(const r of rows){
          try{
            const campaign = getField(r,["Campaign Name","Campaign name","Campaign","Ø§Ù„Ø­Ù…Ù„Ø©"]);
            const adset    = getField(r,["Ad set name","Ad Set Name","Ad Squad","Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©"]);
            const ad       = getField(r,["Ad Name","Ad name","Ad","Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"]);

            const spend   = getNumField(r,["Amount spent (SAR)","Amount spent","Spend","Ø§Ù„Ø¥Ù†ÙØ§Ù‚"]);
            const impr    = getNumField(r,["Impressions","Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹Ø§Øª","Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±"]);
            const results = getNumField(r,["Results","Ø§Ù„Ù†ØªØ§Ø¦Ø¬","Messages","Conversations","Leads"]);
            const cpr     = getNumField(r,["Cost per results","Cost per result","CPL","Cost per message","Cost per conversation"]);
            const conv    = (impr && results) ? (results/impr*100) : null;

            const payload = {
              Platform: plat,
              CampaignName: campaign || "(Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ø­Ù…Ù„Ø©)",
              AdSetName: adset || "",
              AdName: ad || "",
              Spend: spend ?? 0,
              Impressions: impr ?? 0,
              Leads: results ?? 0,
              CostPerLead: cpr,
              CTR: null,
              ConversionRate: conv,
              ResultType: "Messages",
              monthKey: month,
              source: "messages-upload-mobile",
              createdAt: serverTimestamp()
            };

            await addDoc(coll,payload);
            ok++;
          }catch(e){
            fail++;
            log("âŒ Ø®Ø·Ø£ ÙÙŠ ØµÙ: "+e.message);
          }
        }

        log("âœ… ØªÙ… Ø§Ù„Ø±ÙØ¹.");
        log("âœ” ØµÙÙˆÙ Ù†Ø§Ø¬Ø­Ø©: "+ok+" | âŒ ØµÙÙˆÙ ÙØ§Ø´Ù„Ø©: "+fail);

      }catch(err){
        console.error(err);
        log("âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: "+err.message);
      }finally{
        uploadBtn.disabled = false;
      }
    };
  </script>

  <!-- Bottom nav click logic -->
  <script>
    document.querySelectorAll('.bottom-nav .nav-item').forEach(function (item) {
      item.addEventListener('click', function () {
        // Ø´ÙŠÙ„ Active Ù…Ù† Ø§Ù„ÙƒÙ„
        document.querySelectorAll('.bottom-nav .nav-item')
          .forEach(function (el) { el.classList.remove('active'); });

        // Ø­Ø· Active Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ø§ØªØ¯Ø§Ø³ Ø¹Ù„ÙŠÙ‡
        item.classList.add('active');

        // Ù†Øµ Ø§Ù„Ø²Ø±Ø§Ø±
        let text = item.innerText.trim();

        if (text.includes("Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯")) {
          window.location.href = "d-mobile.html";
        } else if (text.includes("Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª")) {
          window.location.href = "u-mobile.html";
        } else if (text.includes("Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„")) {
          window.location.href = "m-mobile.html";
        }
      });
    });
  </script>

</body>
</html>
