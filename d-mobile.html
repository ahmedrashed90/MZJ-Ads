<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MZJ Ads â€” Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Mobile)</title>

  <!-- Tajawal Font -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --muted:#6b7280;
      --line:#e2e8f0;
    }

    *{
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:'Tajawal',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      min-height:100vh;
      background:radial-gradient(circle at top left,#fef3c7,#f5ebe2 40%,#ffffff 80%);
      display:flex;
      flex-direction:column;
      color:#0f172a;
    }

    /* Topbar */
    .topbar{
      background:#3e2420;
      color:#f9fafb;
      padding:10px 14px;
      box-shadow:0 8px 22px rgba(0,0,0,0.45);
      position:sticky;
      top:0;
      z-index:10;
    }
    .topbar-title{
      font-size:15px;
      font-weight:800;
    }
    .topbar-sub{
      font-size:11px;
      opacity:.9;
    }

    /* App container */
    .app{
      flex:1;
      padding:14px 14px 70px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#4b5563;
      margin-bottom:6px;
    }
    .tag-dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#22c55e;
    }

    .card{
      background:#ffffff;
      border-radius:16px;
      padding:14px 12px;
      box-shadow:0 10px 26px rgba(15,23,42,0.12);
      border:1px solid #e2e8f0;
    }

    .card-title{
      font-size:14px;
      font-weight:700;
      color:var(--brown);
      margin-bottom:4px;
    }
    .card-sub{
      font-size:11px;
      color:var(--muted);
      margin-bottom:10px;
    }

    /* Filters mini */
    .filters-mini{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:6px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
    }
    .field label{
      font-weight:600;
      color:var(--brown);
    }
    .field input[type="month"]{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f9fafb;
      font-size:12px;
      outline:none;
    }
    .field input[type="month"]:focus{
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,0.5);
      background:#ffffff;
    }
    .filters-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }

    .btn{
      width:100%;
      padding:9px 0;
      border-radius:999px;
      border:none;
      font-size:13px;
      font-weight:700;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-decoration:none;
    }
    .btn-primary{
      background:#3e2420;
      color:#ffffff;
      box-shadow:0 10px 22px rgba(62,36,32,0.55);
    }
    .btn-secondary{
      background:#ffffff;
      color:var(--brown);
      border:1px dashed #cbd5f5;
    }

    /* KPI cards */
    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
    }
    .kpi-card{
      background:#ffffff;
      border-radius:14px;
      padding:8px 9px;
      border:1px solid #e2e8f0;
      box-shadow:0 8px 18px rgba(15,23,42,0.08);
      font-size:11px;
    }
    .kpi-label{
      color:var(--muted);
      margin-bottom:2px;
    }
    .kpi-value{
      font-size:16px;
      font-weight:800;
      color:var(--brown);
      margin-bottom:2px;
    }
    .kpi-note{
      font-size:10px;
      color:var(--muted);
    }

    .section-title{
      font-size:13px;
      font-weight:700;
      color:var(--brown);
      margin-bottom:6px;
      margin-top:4px;
    }

    .hint{
      font-size:11px;
      color:var(--muted);
      line-height:1.7;
      margin-top:6px;
    }

    /* Bottom nav */
    .bottom-nav{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      height:56px;
      background:#111827;
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:space-around;
      font-size:11px;
      z-index:20;
    }
    .nav-item{
      text-align:center;
      opacity:.8;
      cursor:pointer;
    }
    .nav-item span.icon{
      display:block;
      font-size:16px;
      margin-bottom:2px;
    }
    .nav-item.active{
      opacity:1;
      color:#facc15;
      font-weight:700;
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-title">MZJ Ads Workspace</div>
    <div class="topbar-sub">Ù„ÙˆØ­Ø© ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª â€” Ù†Ø³Ø®Ø© Ø§Ù„Ø¬ÙˆØ§Ù„</div>
  </header>

  <!-- Main content -->
  <main class="app">
    <!-- Filters + CTA -->
    <section class="card">
      <div class="tag">
        <span class="tag-dot"></span>
        <span>Ù…Ù„Ø®Øµ Ø³Ø±ÙŠØ¹ Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„</span>
      </div>

      <div class="card-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø±</div>
      <div class="card-sub">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±ØŒ ÙˆØ³ÙŠØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Firestore Ù…Ø¨Ø§Ø´Ø±Ø©.</div>

      <div class="filters-mini">
        <div class="field">
          <label for="monthMobile">Ø§Ù„Ø´Ù‡Ø±</label>
          <input type="month" id="monthMobile"/>
        </div>
      </div>

      <div class="filters-actions">
        <a href="dashboard.html" class="btn btn-primary">
          ğŸ“Š ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        </a>
        <button type="button" class="btn btn-secondary" id="refreshBtn">
          ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§
        </button>
      </div>

      <p class="hint">
        Ù†Ø³Ø®Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø¹Ù…ÙˆÙ„Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¥Ù†ÙØ§Ù‚ â€“ Ø¸Ù‡ÙˆØ± â€“ Ù†ØªØ§Ø¦Ø¬ â€“ CPL).  
        Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù…ÙŠÙ‚ (Top 50 / Ù…Ù‚Ø§Ø±Ù†Ø© Ø´Ù‡Ø±ÙŠÙ† / Ø§Ù„Ù…Ù†ØµØ§Øª)ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±.
      </p>
    </section>

    <!-- KPI cards -->
    <section>
      <div class="section-title">Ù…Ù„Ø®Øµ KPIs</div>
      <div class="kpi-grid">
        <article class="kpi-card">
          <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚</div>
          <div class="kpi-value" id="kpiSpend">--</div>
          <div class="kpi-note">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…Ù†ØµØ§Øª</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±</div>
          <div class="kpi-value" id="kpiImpr">--</div>
          <div class="kpi-note">Impressions Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ø­Ù…Ù„Ø§Øª</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Leads / Messages)</div>
          <div class="kpi-value" id="kpiConv">--</div>
          <div class="kpi-note">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø­Ù…Ù„Ø§Øª Ø§Ù„Ù…Ù†ØµØ§Øª ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        </article>
        <article class="kpi-card">
          <div class="kpi-label">Ù…ØªÙˆØ³Ø· ØªÙƒÙ„ÙØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© (CPL)</div>
          <div class="kpi-value" id="kpiCPCPL">--</div>
          <div class="kpi-note">Ù…ØªÙˆØ³Ø· Cost per Result Ù…Ù† Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        </article>
      </div>
    </section>

    <section class="card">
      <div class="card-title">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ø³ØªØ®Ø¯Ø§Ù…</div>
      <p class="hint">
        â€¢ ÙŠØªÙ… Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØµØ§Øª Ù…Ù†: <strong>platforms_raw</strong> Ù„ÙƒÙ„ Ø´Ù‡Ø±.<br>
        â€¢ ÙˆÙŠØªÙ… Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù†: <strong>messages_raw</strong> Ù„ÙƒÙ„ Ø´Ù‡Ø±.<br>
        â€¢ ÙŠÙ…ÙƒÙ† ØªØ·ÙˆÙŠØ± Ø§Ù„ÙƒØ±ÙˆØª Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ø¥Ø¸Ù‡Ø§Ø± KPIs Ù„ÙƒÙ„ Ù…Ù†ØµØ© Ø£Ùˆ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø­Ù…Ù„Ø©.
      </p>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="bottom-nav">
    <div class="nav-item active">
      <span class="icon">ğŸ“Š</span>
      Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    </div>
    <div class="nav-item">
      <span class="icon">ğŸ“¤</span>
      Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª
    </div>
    <div class="nav-item">
      <span class="icon">ğŸ’¬</span>
      Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    </div>
  </nav>

  <!-- Firebase + KPIs logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDh7ofrYeZ_KWlk7NJmBuZw0NLm5xkNBks",
      authDomain: "mzj-ads.firebaseapp.com",
      projectId: "mzj-ads",
      storageBucket: "mzj-ads.firebasestorage.app",
      messagingSenderId: "830896442086",
      appId: "1:830896442086:web:f42e7329bd3a8400a90927"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const monthInput = document.getElementById("monthMobile");
    const refreshBtn = document.getElementById("refreshBtn");

    const kSpend = document.getElementById('kpiSpend');
    const kImpr  = document.getElementById('kpiImpr');
    const kConv  = document.getElementById('kpiConv');
    const kCPCPL = document.getElementById('kpiCPCPL');

    function formatNumber(n){
      if (n === null || n === undefined) return "--";
      if (n >= 1000000) return (n/1000000).toFixed(1) + " Ù…";
      if (n >= 1000) return (n/1000).toFixed(1) + " Ø£Ù„Ù";
      return n.toLocaleString();
    }

    async function loadKPIs(){
      const month = monthInput.value;
      if (!month) return;

      // Reset
      kSpend.textContent = "â€¦";
      kImpr.textContent  = "â€¦";
      kConv.textContent  = "â€¦";
      kCPCPL.textContent = "â€¦";

      let totalSpend = 0;
      let totalImpr  = 0;
      let totalConv  = 0;
      let cplList    = [];

      try{
        // Ù…Ù†ØµØ§Øª
        const platRef  = collection(db, "analytics", month, "platforms_raw");
        const platSnap = await getDocs(platRef);

        platSnap.forEach(doc => {
          const d = doc.data() || {};
          totalSpend += d.Spend || 0;
          totalImpr  += d.Impressions || 0;
          // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Leads ÙÙŠ Ø§Ù„Ù…Ù†ØµØ§Øª ØªØ­Ø¨ ØªØ¬Ù…Ø¹Ù‡Ù… ÙƒÙ…Ø§Ù†:
          if (typeof d.Leads === "number") {
            totalConv += d.Leads;
          }
        });

        // Ø±Ø³Ø§Ø¦Ù„
        const msgRef  = collection(db, "analytics", month, "messages_raw");
        const msgSnap = await getDocs(msgRef);

        msgSnap.forEach(doc => {
          const d = doc.data() || {};
          if (typeof d.Leads === "number") {
            totalConv += d.Leads;
          }
          if (typeof d.CostPerLead === "number" && d.CostPerLead > 0) {
            cplList.push(d.CostPerLead);
          }
        });

        const avgCPL = cplList.length
          ? (cplList.reduce((a,b)=>a+b,0) / cplList.length)
          : 0;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        kSpend.textContent = formatNumber(totalSpend) + " Ø±.Ø³";
        kImpr.textContent  = formatNumber(totalImpr);
        kConv.textContent  = formatNumber(totalConv) + " Ù†ØªÙŠØ¬Ø©";
        kCPCPL.textContent = avgCPL ? avgCPL.toFixed(2) + " Ø±.Ø³" : "--";

      }catch(err){
        console.error(err);
        kSpend.textContent = "--";
        kImpr.textContent  = "--";
        kConv.textContent  = "--";
        kCPCPL.textContent = "--";
      }
    }

    // Ø¶Ø¨Ø· Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    (function presetMonth(){
      if (!monthInput) return;
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,"0");
      monthInput.value = `${y}-${m}`;
    })();

    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±
    monthInput.addEventListener("change", loadKPIs);
    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
    refreshBtn.addEventListener("click", loadKPIs);

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø¯Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    window.addEventListener("DOMContentLoaded", () => {
      loadKPIs();
    });
  </script>

  <!-- Bottom nav click logic -->
  <script>
    document.querySelectorAll('.bottom-nav .nav-item').forEach(function (item) {
      item.addEventListener('click', function () {
        // Ø´ÙŠÙ„ Active Ù…Ù† Ø§Ù„ÙƒÙ„
        document.querySelectorAll('.bottom-nav .nav-item')
          .forEach(function (el) { el.classList.remove('active'); });

        // Ø­Ø· Active Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ø§ØªØ¯Ø§Ø³ Ø¹Ù„ÙŠÙ‡
        item.classList.add('active');

        // Ù†Øµ Ø§Ù„Ø²Ø±Ø§Ø±
        let text = item.innerText.trim();

        if (text.includes("Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯")) {
          window.location.href = "d-mobile.html";
        } else if (text.includes("Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª")) {
          window.location.href = "u-mobile.html";
        } else if (text.includes("Ø±ÙØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„")) {
          window.location.href = "m-mobile.html";
        }
      });
    });
  </script>

</body>
</html>
